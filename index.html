<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–®–∫–æ–ª—å–Ω—ã–π –î–Ω–µ–≤–Ω–∏–∫</title>
<link href="https://fonts.googleapis.com/css2?family=Geologica:wght@300;400;500;600;700&family=Unbounded:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f0f14;
    --surface: #16161e;
    --surface2: #1e1e2a;
    --surface3: #252535;
    --border: rgba(255,255,255,0.07);
    --accent: #e8a45a;
    --accent2: #c97fd4;
    --accent3: #5acfe8;
    --accent4: #5ae8a4;
    --text: #e8e8f0;
    --text2: #9090aa;
    --text3: #5a5a72;
    --danger: #e85a5a;
    --success: #5ae8a4;
    --r: 14px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Geologica', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 60% 40% at 20% 20%, rgba(232,164,90,0.08) 0%, transparent 70%),
      radial-gradient(ellipse 50% 50% at 80% 80%, rgba(201,127,212,0.06) 0%, transparent 70%),
      radial-gradient(ellipse 40% 60% at 60% 40%, rgba(90,207,232,0.04) 0%, transparent 70%);
    pointer-events: none;
    z-index: 0;
  }

  .app {
    position: relative;
    z-index: 1;
    max-width: 960px;
    margin: 0 auto;
    padding: 24px 16px 80px;
  }

  /* Header */
  header {
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    margin-bottom: 28px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }

  .logo { display: flex; flex-direction: column; gap: 4px; }

  .logo-tag {
    font-size: 10px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--accent);
    font-weight: 500;
  }

  .logo-title {
    font-family: 'Unbounded', sans-serif;
    font-size: clamp(20px, 5vw, 28px);
    font-weight: 700;
    line-height: 1;
    background: linear-gradient(135deg, var(--text) 0%, var(--accent) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .date-badge {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 8px 14px;
    text-align: right;
  }

  .date-badge .day { font-size: clamp(16px, 4vw, 22px); font-weight: 600; color: var(--text); line-height: 1; }
  .date-badge .weekday { font-size: 10px; color: var(--text2); text-transform: uppercase; letter-spacing: 0.12em; margin-top: 3px; }

  /* Tabs */
  .tabs {
    display: flex;
    gap: 3px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--r);
    padding: 4px;
    margin-bottom: 20px;
    overflow-x: auto;
  }

  .tab-btn {
    flex: 1;
    min-width: 0;
    padding: 10px 8px;
    border: none;
    border-radius: calc(var(--r) - 3px);
    background: transparent;
    color: var(--text2);
    font-family: 'Geologica', sans-serif;
    font-size: clamp(11px, 2.5vw, 13px);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.25s ease;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    white-space: nowrap;
  }

  .tab-btn:hover:not(.active) { color: var(--text); background: var(--surface2); }

  .tab-btn.active { background: var(--surface3); color: var(--text); }

  .tab-btn.active::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 50%;
    transform: translateX(-50%);
    width: 24px;
    height: 2px;
    border-radius: 2px;
  }

  .tab-btn[data-tab="lessons"].active::after { background: var(--accent); }
  .tab-btn[data-tab="subs"].active::after { background: var(--accent2); }
  .tab-btn[data-tab="hw"].active::after { background: var(--accent3); }
  .tab-btn[data-tab="todo"].active::after { background: var(--accent4); }

  .tab-btn[data-tab="lessons"].active .tab-icon { color: var(--accent); }
  .tab-btn[data-tab="subs"].active .tab-icon { color: var(--accent2); }
  .tab-btn[data-tab="hw"].active .tab-icon { color: var(--accent3); }
  .tab-btn[data-tab="todo"].active .tab-icon { color: var(--accent4); }

  .tab-icon { font-size: 14px; }

  .badge {
    background: var(--accent2);
    color: white;
    font-size: 10px;
    font-weight: 700;
    padding: 1px 5px;
    border-radius: 20px;
    line-height: 1.6;
    opacity: 0;
    transform: scale(0.8);
    transition: all 0.2s;
  }
  .badge.show { opacity: 1; transform: scale(1); }

  /* Panels */
  .panel { display: none; animation: fadeIn 0.3s ease; }
  .panel.active { display: block; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Section header */
  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 14px;
    gap: 8px;
  }

  .section-title {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.18em;
    color: var(--text3);
  }

  .add-btn {
    display: flex;
    align-items: center;
    gap: 5px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text2);
    font-family: 'Geologica', sans-serif;
    font-size: clamp(11px, 2.5vw, 13px);
    font-weight: 500;
    padding: 8px 12px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .add-btn:hover { background: var(--surface3); color: var(--text); border-color: rgba(255,255,255,0.12); }

  /* Day selector */
  .day-selector {
    display: flex;
    gap: 5px;
    margin-bottom: 16px;
    overflow-x: auto;
    padding-bottom: 4px;
    -webkit-overflow-scrolling: touch;
  }

  .day-selector::-webkit-scrollbar { height: 3px; }
  .day-selector::-webkit-scrollbar-track { background: transparent; }
  .day-selector::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 3px; }

  .day-pill {
    flex-shrink: 0;
    padding: 8px 14px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text2);
    font-family: 'Geologica', sans-serif;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .day-pill:hover { color: var(--text); border-color: rgba(255,255,255,0.12); }
  .day-pill.active { background: var(--surface3); color: var(--text); border-color: rgba(255,255,255,0.15); }

  /* Lists */
  .lessons-list, .hw-list, .subs-list { display: flex; flex-direction: column; gap: 7px; }

  /* Lesson card */
  .lesson-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-left: 3px solid transparent;
    border-radius: var(--r);
    padding: 13px 14px;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.2s;
    position: relative;
  }

  .lesson-card:hover { background: var(--surface2); border-right-color: rgba(255,255,255,0.1); }

  .lesson-num {
    width: 30px;
    height: 30px;
    border-radius: 8px;
    background: var(--surface2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
    color: var(--text2);
    flex-shrink: 0;
  }

  .lesson-info { flex: 1; min-width: 0; }

  .lesson-name {
    font-size: clamp(13px, 3.5vw, 15px);
    font-weight: 500;
    color: var(--text);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .lesson-meta { font-size: 11px; color: var(--text3); margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  .lesson-divider {
    padding: 8px 0 4px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: var(--text3);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .lesson-divider::before, .lesson-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .lunch-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--r);
    padding: 10px 14px;
    display: flex;
    align-items: center;
    gap: 12px;
    opacity: 0.5;
  }
  .lunch-card .lesson-name { color: var(--text2); font-size: 13px; }

  .card-actions {
    display: flex;
    gap: 5px;
    opacity: 0;
    transition: opacity 0.2s;
    flex-shrink: 0;
  }

  .lesson-card:hover .card-actions,
  .hw-card:hover .card-actions,
  .sub-card:hover .card-actions { opacity: 1; }

  /* Touch devices ‚Äî always show actions */
  @media (hover: none) {
    .card-actions { opacity: 1; }
  }

  .icon-btn {
    width: 28px;
    height: 28px;
    border-radius: 7px;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--text2);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    transition: all 0.2s;
    flex-shrink: 0;
  }

  .icon-btn:hover { background: var(--surface3); color: var(--text); }
  .icon-btn.del:hover { background: rgba(232,90,90,0.15); color: var(--danger); border-color: rgba(232,90,90,0.3); }

  /* Homework */
  .stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-bottom: 20px;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--r);
    padding: 14px 12px;
    text-align: center;
  }

  .stat-num { font-family: 'Unbounded', sans-serif; font-size: clamp(18px, 5vw, 24px); font-weight: 700; line-height: 1; }
  .stat-label { font-size: 10px; color: var(--text3); margin-top: 5px; text-transform: uppercase; letter-spacing: 0.1em; }

  .hw-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--r);
    padding: 14px 14px;
    transition: all 0.2s;
  }

  .hw-card:hover { background: var(--surface2); border-color: rgba(255,255,255,0.1); }
  .hw-card.done { opacity: 0.5; }
  .hw-card.done .hw-title { text-decoration: line-through; color: var(--text3); }

  .hw-top {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 6px;
  }

  .hw-checkbox {
    width: 20px;
    height: 20px;
    border-radius: 6px;
    border: 2px solid var(--border);
    background: transparent;
    cursor: pointer;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    color: var(--success);
    transition: all 0.2s;
  }

  .hw-card.done .hw-checkbox { background: rgba(90,232,164,0.15); border-color: var(--success); }

  .hw-title { font-size: clamp(13px, 3.5vw, 15px); font-weight: 500; flex: 1; min-width: 0; }

  .hw-subject {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 2px 7px;
    border-radius: 6px;
    border: 1px solid;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .hw-desc { font-size: 12px; color: var(--text2); line-height: 1.5; padding-left: 30px; }

  .hw-due { font-size: 11px; color: var(--text3); margin-top: 6px; padding-left: 30px; }
  .hw-due.overdue { color: var(--danger); }

  /* Subs */
  .sub-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--r);
    padding: 13px 14px;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.2s;
  }

  .sub-card:hover { background: var(--surface2); border-color: rgba(255,255,255,0.1); }

  .sub-lesson {
    width: 34px;
    height: 34px;
    border-radius: 9px;
    background: rgba(201,127,212,0.12);
    border: 1px solid rgba(201,127,212,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    font-weight: 700;
    color: var(--accent2);
    flex-shrink: 0;
  }

  .sub-arrow { display: flex; flex-direction: column; gap: 2px; }
  .sub-old { font-size: 11px; color: var(--danger); text-decoration: line-through; }
  .sub-arrow-icon { color: var(--text3); font-size: 12px; }
  .sub-new { font-size: 13px; color: var(--success); font-weight: 500; }

  /* TODO */
  .todo-header {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--r);
    padding: 16px 18px;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
  }

  .todo-header-info {}
  .todo-tomorrow-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.2em; color: var(--accent4); margin-bottom: 4px; }
  .todo-tomorrow-day { font-family: 'Unbounded', sans-serif; font-size: clamp(16px, 4vw, 20px); color: var(--text); }

  .todo-progress-wrap { flex-shrink: 0; text-align: right; }
  .todo-progress-num { font-family: 'Unbounded', sans-serif; font-size: clamp(18px, 5vw, 24px); font-weight: 700; color: var(--accent4); line-height: 1; }
  .todo-progress-label { font-size: 10px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.1em; margin-top: 3px; }

  .todo-progress-bar {
    height: 3px;
    background: var(--surface3);
    border-radius: 3px;
    margin-top: 12px;
    overflow: hidden;
  }
  .todo-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent4), var(--accent3));
    border-radius: 3px;
    transition: width 0.4s ease;
  }

  .todo-list { display: flex; flex-direction: column; gap: 7px; }

  .todo-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-left: 3px solid transparent;
    border-radius: var(--r);
    padding: 13px 14px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    transition: all 0.2s;
    user-select: none;
  }

  .todo-item:hover { background: var(--surface2); }
  .todo-item.done { opacity: 0.45; }
  .todo-item.done .todo-item-name { text-decoration: line-through; color: var(--text3); }

  .todo-check {
    width: 22px;
    height: 22px;
    border-radius: 7px;
    border: 2px solid var(--border);
    background: transparent;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    color: var(--success);
    transition: all 0.2s;
  }

  .todo-item.done .todo-check { background: rgba(90,232,164,0.15); border-color: var(--success); }

  .todo-item-num {
    width: 28px;
    height: 28px;
    border-radius: 7px;
    background: var(--surface2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 600;
    flex-shrink: 0;
  }

  .todo-item-info { flex: 1; min-width: 0; }
  .todo-item-name { font-size: clamp(13px, 3.5vw, 15px); font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .todo-item-meta { font-size: 11px; color: var(--text3); margin-top: 2px; }

  .todo-sub-badge {
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 2px 7px;
    border-radius: 5px;
    background: rgba(201,127,212,0.15);
    color: var(--accent2);
    border: 1px solid rgba(201,127,212,0.2);
    flex-shrink: 0;
  }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text3);
  }

  .empty-icon { font-size: 36px; margin-bottom: 10px; }
  .empty-text { font-size: 14px; }

  /* Modal */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(8px);
    z-index: 100;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    padding: 0;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s;
  }

  @media (min-width: 600px) {
    .modal-overlay { align-items: center; padding: 20px; }
  }

  .modal-overlay.open { opacity: 1; pointer-events: all; }

  .modal {
    background: var(--surface);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 20px 20px 0 0;
    padding: 24px 20px calc(24px + env(safe-area-inset-bottom));
    width: 100%;
    max-width: 480px;
    transform: translateY(30px);
    transition: transform 0.3s ease;
    box-shadow: 0 -20px 60px rgba(0,0,0,0.5);
    max-height: 90vh;
    overflow-y: auto;
  }

  @media (min-width: 600px) {
    .modal {
      border-radius: 20px;
      padding: 28px;
      transform: translateY(20px) scale(0.97);
    }
    .modal-overlay.open .modal { transform: translateY(0) scale(1); }
  }

  .modal-overlay.open .modal { transform: translateY(0); }

  /* Modal drag indicator */
  .modal::before {
    content: '';
    display: block;
    width: 40px;
    height: 4px;
    border-radius: 4px;
    background: var(--surface3);
    margin: 0 auto 20px;
  }

  @media (min-width: 600px) { .modal::before { display: none; } }

  .modal-title { font-family: 'Unbounded', sans-serif; font-size: 16px; margin-bottom: 20px; color: var(--text); }

  .form-group { margin-bottom: 14px; }

  .form-label {
    display: block;
    font-size: 11px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--text3);
    margin-bottom: 7px;
  }

  .form-input, .form-textarea {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-family: 'Geologica', sans-serif;
    font-size: 14px;
    padding: 11px 14px;
    outline: none;
    transition: border-color 0.2s;
    -webkit-appearance: none;
  }

  .form-input:focus, .form-textarea:focus { border-color: rgba(255,255,255,0.2); }
  .form-textarea { resize: vertical; min-height: 70px; }

  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

  .color-palette { display: flex; flex-wrap: wrap; gap: 8px; }

  .color-swatch {
    width: 28px;
    height: 28px;
    border-radius: 8px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.2s;
  }

  .color-swatch.selected { border-color: white; transform: scale(1.15); }
  .color-swatch:hover:not(.selected) { transform: scale(1.1); }

  .modal-actions {
    display: flex;
    gap: 8px;
    margin-top: 20px;
  }

  .btn {
    flex: 1;
    padding: 13px;
    border-radius: 11px;
    border: none;
    font-family: 'Geologica', sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-ghost { background: var(--surface2); color: var(--text2); border: 1px solid var(--border); }
  .btn-ghost:hover { background: var(--surface3); color: var(--text); }
  .btn-primary { background: linear-gradient(135deg, var(--accent), #c97b2a); color: #000; }
  .btn-primary:hover { opacity: 0.9; }
  .btn-primary-purple { background: linear-gradient(135deg, var(--accent2), #9b4db8); color: white; }
  .btn-primary-blue { background: linear-gradient(135deg, var(--accent3), #2a7fc9); color: #000; }
  .btn-primary-green { background: linear-gradient(135deg, var(--accent4), #2ac97f); color: #000; }

  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 4px; }

  /* Bottom nav for mobile */
  @media (max-width: 599px) {
    .app { padding-bottom: 90px; }

    .tabs {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 50;
      border-radius: 16px 16px 0 0;
      margin-bottom: 0;
      padding: 8px 8px calc(8px + env(safe-area-inset-bottom));
      border-bottom: none;
    }

    .tab-btn {
      flex-direction: column;
      gap: 3px;
      padding: 8px 4px;
      font-size: 9px;
    }

    .tab-btn.active::after { bottom: -4px; }
    .tab-icon { font-size: 18px; }
  }
</style>
</head>
<body>

<div class="app">
  <header>
    <div class="logo">
      <span class="logo-tag">–º–æ–π –¥–Ω–µ–≤–Ω–∏–∫</span>
      <span class="logo-title">SchoolBook</span>
    </div>
    <div class="date-badge">
      <div class="day" id="current-date"></div>
      <div class="weekday" id="current-weekday"></div>
    </div>
  </header>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="lessons" onclick="switchTab('lessons')">
      <span class="tab-icon">üìö</span><span>–£—Ä–æ–∫–∏</span>
    </button>
    <button class="tab-btn" data-tab="subs" onclick="switchTab('subs')">
      <span class="tab-icon">üîÑ</span><span>–ó–∞–º–µ–Ω—ã</span>
      <span class="badge" id="subs-badge"></span>
    </button>
    <button class="tab-btn" data-tab="hw" onclick="switchTab('hw')">
      <span class="tab-icon">‚úèÔ∏è</span><span>–î–æ–º–∞—à–∫–∞</span>
      <span class="badge" id="hw-badge"></span>
    </button>
    <button class="tab-btn" data-tab="todo" onclick="switchTab('todo')">
      <span class="tab-icon">‚úÖ</span><span>–ù–∞ –∑–∞–≤—Ç—Ä–∞</span>
      <span class="badge" id="todo-badge"></span>
    </button>
  </div>

  <!-- –£–†–û–ö–ò -->
  <div class="panel active" id="panel-lessons">
    <div class="day-selector" id="lessons-days"></div>
    <div class="section-header">
      <span class="section-title" id="lessons-day-title">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</span>
      <button class="add-btn" onclick="openModal('lesson')">Ôºã –£—Ä–æ–∫</button>
    </div>
    <div class="lessons-list" id="lessons-list"></div>
  </div>

  <!-- –ó–ê–ú–ï–ù–´ -->
  <div class="panel" id="panel-subs">
    <div class="day-selector" id="subs-days"></div>
    <div class="section-header">
      <span class="section-title" id="subs-day-title">–ó–∞–º–µ–Ω—ã</span>
      <button class="add-btn" onclick="openModal('sub')">Ôºã –ó–∞–º–µ–Ω—É</button>
    </div>
    <div class="subs-list" id="subs-list"></div>
  </div>

  <!-- –î–û–ú–ê–®–ö–ê -->
  <div class="panel" id="panel-hw">
    <div class="stats">
      <div class="stat-card">
        <div class="stat-num" id="hw-total" style="color:var(--accent3)">0</div>
        <div class="stat-label">–í—Å–µ–≥–æ</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" id="hw-done" style="color:var(--success)">0</div>
        <div class="stat-label">–°–¥–∞–Ω–æ</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" id="hw-left" style="color:var(--accent)">0</div>
        <div class="stat-label">–û—Å—Ç–∞–ª–æ—Å—å</div>
      </div>
    </div>
    <div class="section-header">
      <span class="section-title">–ó–∞–¥–∞–Ω–∏—è</span>
      <button class="add-btn" onclick="openModal('hw')">Ôºã –ó–∞–¥–∞–Ω–∏–µ</button>
    </div>
    <div class="hw-list" id="hw-list"></div>
  </div>

  <!-- TODO -->
  <div class="panel" id="panel-todo">
    <div class="todo-header">
      <div class="todo-header-info">
        <div class="todo-tomorrow-label">–£—á—ë–±–∞ –Ω–∞ –∑–∞–≤—Ç—Ä–∞</div>
        <div class="todo-tomorrow-day" id="todo-tomorrow-day">‚Äî</div>
      </div>
      <div class="todo-progress-wrap">
        <div class="todo-progress-num" id="todo-done-count">0/0</div>
        <div class="todo-progress-label">—É—Ä–æ–∫–æ–≤ –≥–æ—Ç–æ–≤–æ</div>
      </div>
    </div>
    <div class="todo-progress-bar">
      <div class="todo-progress-fill" id="todo-progress-fill" style="width:0%"></div>
    </div>
    <br>
    <div class="todo-list" id="todo-list"></div>
  </div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modal-overlay" onclick="closeModalOutside(event)">
  <div class="modal" id="modal">
    <div class="modal-title" id="modal-title">–î–æ–±–∞–≤–∏—Ç—å</div>
    <div id="modal-body"></div>
    <div class="modal-actions" id="modal-actions"></div>
  </div>
</div>

<script>
// ===== CONSTANTS =====
const DAYS = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–í—Ç–æ—Ä–Ω–∏–∫','–°—Ä–µ–¥–∞','–ß–µ—Ç–≤–µ—Ä–≥','–ü—è—Ç–Ω–∏—Ü–∞','–°—É–±–±–æ—Ç–∞'];
const SHORT_DAYS = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'];
const COLORS = ['#e85a5a','#e8a45a','#e8e85a','#5ae870','#5acfe8','#5a70e8','#c97fd4','#e8709a'];

// Bell schedule
const BELLS = [
  '08:15‚Äì09:00','09:10‚Äì09:55','10:05‚Äì10:50','11:00‚Äì11:45',
  '11:55‚Äì12:40','12:50‚Äì13:35','13:45‚Äì14:30','14:40‚Äì15:25',
  '15:35‚Äì16:20','16:30‚Äì17:15','17:25‚Äì18:10','18:20‚Äì19:05','19:15‚Äì20:00'
];

// Default schedule (–ü–Ω=0, –í—Ç=1, –°—Ä=2, –ß—Ç=3, –ü—Ç=4, –°–±=5)
const DEFAULT_SCHEDULE = {
  0: [ // –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
    { num:1, name:'–ò—Å—Ç–æ—Ä–∏—è –ë–µ–ª–∞—Ä—É—Å–∏', room:'17', color:'#e85a5a' },
    { num:2, name:'–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', room:'34', color:'#e8a45a' },
    { num:3, name:'–≠–ª–µ–∫—Ç—Ä–æ—Ç–µ—Ö–Ω–∏–∫–∞', room:'5 –ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è', color:'#5a70e8' },
    { num:4, name:'–•–∏–º–∏—è', room:'32', color:'#5ae870' },
    { num:5, name:'–û–ë–ï–î', room:'', color:'#5a5a72', isLunch:true },
    { num:6, name:'–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π –Ø–∑—ã–∫', room:'35', color:'#c97fd4' },
    { num:7, name:'–ë–µ–ª–æ—Ä—É—Å—Å–∫–∞—è –õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', room:'35', color:'#c97fd4' },
    { num:8, name:'–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', room:'—Å/–∑', color:'#5acfe8' },
    { num:9, name:'–û—Å–Ω–æ–≤—ã –í–¢ (1–ø–≥.)', room:'26', color:'#e8709a', note:'1 –ø–æ–¥–≥—Ä—É–ø–ø–∞' },
  ],
  1: [ // –í—Ç–æ—Ä–Ω–∏–∫ ‚Äî –ü/–û
    { num:0, name:'–ü/–û –ú–∞—Å—Ç–µ—Ä—Å–∫–∏–µ', room:'', color:'#e8a45a', note:'08:00‚Äì15:25, –æ–±–µ–¥ 11:55‚Äì12:40', isSpecial:true },
    { num:0, name:'–ö—É—Ä–∞—Ç–æ—Ä—Å–∫–∏–π —á–∞—Å', room:'', color:'#5a70e8', note:'12:50‚Äì13:35', isSpecial:true },
  ],
  2: [ // –°—Ä–µ–¥–∞
    { num:1, name:'–û—Ö—Ä–∞–Ω–∞ –¢—Ä—É–¥–∞', room:'44', color:'#e85a5a' },
    { num:2, name:'–ò—Å—Ç–æ—Ä–∏—è –ë–µ–ª–∞—Ä—É—Å–∏', room:'17', color:'#e85a5a' },
    { num:3, name:'–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –°–∏—Å—Ç–µ–º—ã (1–ø–≥.)', room:'26', color:'#5acfe8', note:'1–ø–≥ / –ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π –Ø–∑—ã–∫ 2–ø–≥ –∫–∞–±.13' },
    { num:4, name:'–ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π –Ø–∑—ã–∫ (1–ø–≥.)', room:'26–∞', color:'#5ae870', note:'1–ø–≥ / –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –°–∏—Å—Ç–µ–º—ã 2–ø–≥ –∫–∞–±.26' },
    { num:5, name:'–û–ë–ï–î', room:'', color:'#5a5a72', isLunch:true },
    { num:6, name:'–ë–∏–æ–ª–æ–≥–∏—è', room:'32', color:'#5ae870' },
    { num:7, name:'–°–ø–µ—Ü—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è (–û—Å–∞–¥—á–∏–π)', room:'21', color:'#e8709a' },
    { num:8, name:'–§–∏–∑–∏–∫–∞', room:'21', color:'#5a70e8' },
  ],
  3: [ // –ß–µ—Ç–≤–µ—Ä–≥
    { num:1, name:'–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', room:'34', color:'#e8a45a' },
    { num:2, name:'–≠–ª–µ–∫—Ç—Ä–æ—Ç–µ—Ö–Ω–∏–∫–∞', room:'5 –ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è', color:'#5a70e8' },
    { num:3, name:'–†—É—Å—Å–∫–∏–π –Ø–∑—ã–∫', room:'31', color:'#c97fd4' },
    { num:4, name:'–†–∞–¥–∏–æ—ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞', room:'32', color:'#e85a5a' },
    { num:5, name:'–û–ë–ï–î', room:'', color:'#5a5a72', isLunch:true },
    { num:6, name:'–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –ß–∞—Å', room:'', color:'#5a5a72' },
    { num:7, name:'–ê—Å—Ç—Ä–æ–Ω–æ–º–∏—è', room:'21', color:'#5acfe8' },
    { num:8, name:'–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', room:'—Å/–∑', color:'#5acfe8' },
    { num:9, name:'–†—É—Å—Å–∫–∞—è –õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', room:'31', color:'#c97fd4' },
    { num:10, name:'–†–∞–¥–∏–æ—ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞', room:'31', color:'#e85a5a' },
  ],
  4: [ // –ü—è—Ç–Ω–∏—Ü–∞
    { num:1, name:'–•–∏–º–∏—è', room:'32', color:'#5ae870' },
    { num:2, name:'–°–ø–µ—Ü—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è (–û—Å–∞–¥—á–∏–π)', room:'21', color:'#e8709a' },
    { num:3, name:'–°–ø–µ—Ü—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è (–û—Å–∞–¥—á–∏–π)', room:'32', color:'#e8709a' },
    { num:4, name:'–°–ø–µ—Ü—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è (–ù–∏–∫–∏—Ç–µ–Ω–∫–æ)', room:'21', color:'#e8a45a' },
    { num:5, name:'–û–ë–ï–î', room:'', color:'#5a5a72', isLunch:true },
    { num:6, name:'–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', room:'—Å/–∑', color:'#5acfe8', note:'–Ω–∞–¥ —á–µ—Ä—Ç–æ–π' },
    { num:6, name:'–≠–ª–µ–∫—Ç—Ä–æ—Ç–µ—Ö–Ω–∏–∫–∞', room:'5 –ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è', color:'#5a70e8', note:'–ø–æ–¥ —á–µ—Ä—Ç–æ–π' },
    { num:7, name:'–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', room:'34', color:'#e8a45a' },
  ],
};

// ===== STATE =====
let state = {
  lessons: JSON.parse(localStorage.getItem('sb_lessons') || 'null'),
  subs: JSON.parse(localStorage.getItem('sb_subs') || '{}'),
  hw: JSON.parse(localStorage.getItem('sb_hw') || '[]'),
  todo: JSON.parse(localStorage.getItem('sb_todo') || '{}'), // { "dayKey": { "itemId": bool } }
};

// Seed default schedule if empty
if (!state.lessons) {
  state.lessons = {};
  Object.entries(DEFAULT_SCHEDULE).forEach(([dayIdx, items]) => {
    state.lessons[dayIdx] = items.map(item => ({
      id: uid(),
      name: item.name,
      num: item.num,
      time: item.num > 0 && item.num <= 13 ? BELLS[item.num - 1] : (item.note || ''),
      teacher: '',
      room: item.room,
      color: item.color,
      note: item.note || '',
      isLunch: item.isLunch || false,
      isSpecial: item.isSpecial || false,
    }));
  });
  save();
}

let currentLessonsDay = 0;
let currentSubsDay = 0;
let editingId = null;
let selectedColor = COLORS[0];

function save() {
  localStorage.setItem('sb_lessons', JSON.stringify(state.lessons));
  localStorage.setItem('sb_subs', JSON.stringify(state.subs));
  localStorage.setItem('sb_hw', JSON.stringify(state.hw));
  localStorage.setItem('sb_todo', JSON.stringify(state.todo));
}

function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2); }

// ===== DATE =====
let todayDayIndex = 0; // 0=–ü–Ω..4=–ü—Ç

function initDate() {
  const now = new Date();
  const months = ['—è–Ω–≤','—Ñ–µ–≤','–º–∞—Ä','–∞–ø—Ä','–º–∞–π','–∏—é–Ω','–∏—é–ª','–∞–≤–≥','—Å–µ–Ω','–æ–∫—Ç','–Ω–æ—è','–¥–µ–∫'];
  const wdays = ['–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ','–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–í—Ç–æ—Ä–Ω–∏–∫','–°—Ä–µ–¥–∞','–ß–µ—Ç–≤–µ—Ä–≥','–ü—è—Ç–Ω–∏—Ü–∞','–°—É–±–±–æ—Ç–∞'];
  document.getElementById('current-date').textContent = now.getDate() + ' ' + months[now.getMonth()];
  document.getElementById('current-weekday').textContent = wdays[now.getDay()];
  const d = now.getDay();
  todayDayIndex = (d === 0 || d === 7) ? 0 : d - 1;
  currentLessonsDay = todayDayIndex;
  currentSubsDay = todayDayIndex;
}

function getTomorrowDayIndex() {
  const now = new Date();
  const d = now.getDay(); // 0=Sun..6=Sat
  // Mon=1..Sat=6, Sun=0
  // our index: Mon=0..Sat=5
  let nextD = (d + 1) % 7;
  if (nextD === 0) nextD = 1; // Sunday -> Monday
  return nextD - 1; // 0-indexed
}

// ===== TABS =====
function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
  document.querySelectorAll('.panel').forEach(p => p.classList.toggle('active', p.id === 'panel-' + tab));
  if (tab === 'todo') renderTodo();
}

// ===== DAY SELECTORS =====
function renderDaySelector(containerId, current, setCurrent, onSelect) {
  const el = document.getElementById(containerId);
  el.innerHTML = '';
  DAYS.forEach((day, i) => {
    // Only Mon-Fri for lessons/subs
    if (i > 4 && containerId !== 'lessons-days-all') return;
    const btn = document.createElement('button');
    btn.className = 'day-pill' + (i === current ? ' active' : '');
    btn.textContent = SHORT_DAYS[i];
    btn.onclick = () => {
      setCurrent(i);
      onSelect();
      renderDaySelector(containerId, i, setCurrent, onSelect);
    };
    el.appendChild(btn);
  });
}

// ===== LESSONS =====
function renderLessons() {
  const key = currentLessonsDay;
  const items = (state.lessons[key] || []).sort((a, b) => a.num - b.num);
  const list = document.getElementById('lessons-list');
  document.getElementById('lessons-day-title').textContent = DAYS[key];

  if (!items.length) {
    list.innerHTML = `<div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-text">–ù–µ—Ç —É—Ä–æ–∫–æ–≤</div></div>`;
    return;
  }

  list.innerHTML = '';

  // Check for special day (–í—Ç–æ—Ä–Ω–∏–∫ = –ü/–û)
  const hasSpecial = items.some(i => i.isSpecial);
  if (hasSpecial) {
    items.forEach(item => {
      const card = document.createElement('div');
      card.className = 'lesson-card';
      card.style.borderLeftColor = item.color;
      card.innerHTML = `
        <div class="lesson-num" style="color:${item.color};background:${item.color}15">‚Äì</div>
        <div class="lesson-info">
          <div class="lesson-name">${item.name}</div>
          <div class="lesson-meta">${item.time || item.note || ''}</div>
        </div>
        <div class="card-actions">
          <button class="icon-btn" onclick="editLesson('${item.id}',${key})">‚úé</button>
          <button class="icon-btn del" onclick="deleteLesson('${item.id}',${key})">‚úï</button>
        </div>`;
      list.appendChild(card);
    });
    return;
  }

  // Group by num to detect duplicates (over/under —á–µ—Ä—Ç–æ–π)
  const byNum = {};
  items.forEach(item => {
    if (!byNum[item.num]) byNum[item.num] = [];
    byNum[item.num].push(item);
  });

  const sortedNums = Object.keys(byNum).map(Number).sort((a, b) => a - b);

  sortedNums.forEach(num => {
    const group = byNum[num];

    if (group.length > 1) {
      // Multiple lessons at same slot ‚Äî show divider
      list.appendChild(createDivider('–ù–∞–¥ —á–µ—Ä—Ç–æ–π'));
      renderLessonCard(list, group[0], key);
      list.appendChild(createDivider('–ü–æ–¥ —á–µ—Ä—Ç–æ–π'));
      renderLessonCard(list, group[1], key);
    } else {
      renderLessonCard(list, group[0], key);
    }
  });
}

function createDivider(text) {
  const el = document.createElement('div');
  el.className = 'lesson-divider';
  el.textContent = text;
  return el;
}

function renderLessonCard(list, item, key) {
  if (item.isLunch) {
    const card = document.createElement('div');
    card.className = 'lunch-card';
    card.innerHTML = `
      <div class="lesson-num" style="color:var(--text3)">üçΩ</div>
      <div class="lesson-info">
        <div class="lesson-name">–û–±–µ–¥</div>
        <div class="lesson-meta">${BELLS[4]}</div>
      </div>`;
    list.appendChild(card);
    return;
  }

  const card = document.createElement('div');
  card.className = 'lesson-card';
  card.style.borderLeftColor = item.color;
  const time = item.num > 0 && item.num <= 13 ? BELLS[item.num - 1] : '';
  card.innerHTML = `
    <div class="lesson-num" style="color:${item.color};background:${item.color}15">${item.num}</div>
    <div class="lesson-info">
      <div class="lesson-name">${item.name}</div>
      <div class="lesson-meta">${item.room ? '–∫–∞–±. ' + item.room : ''}${item.room && time ? ' ¬∑ ' : ''}${time}${item.note ? ' ¬∑ ' + item.note : ''}</div>
    </div>
    <div class="card-actions">
      <button class="icon-btn" onclick="editLesson('${item.id}',${key})">‚úé</button>
      <button class="icon-btn del" onclick="deleteLesson('${item.id}',${key})">‚úï</button>
    </div>`;
  card.dataset.id = item.id;
  list.appendChild(card);
}

function deleteLesson(id, day) {
  state.lessons[day] = (state.lessons[day] || []).filter(l => l.id !== id);
  save(); renderLessons();
}

function editLesson(id, day) {
  const item = state.lessons[day].find(l => l.id === id);
  editingId = id;
  openModal('lesson', item);
}

// ===== SUBS =====
function renderSubs() {
  const key = currentSubsDay;
  const items = state.subs[key] || [];
  const list = document.getElementById('subs-list');
  const badge = document.getElementById('subs-badge');

  document.getElementById('subs-day-title').textContent = '–ó–∞–º–µ–Ω—ã ‚Äî ' + DAYS[key];

  const total = Object.values(state.subs).flat().length;
  badge.textContent = total;
  badge.classList.toggle('show', total > 0);

  if (!items.length) {
    list.innerHTML = `<div class="empty-state"><div class="empty-icon">‚úÖ</div><div class="empty-text">–ó–∞–º–µ–Ω –Ω–µ—Ç ‚Äî –≤—Å—ë –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é</div></div>`;
    return;
  }

  list.innerHTML = '';
  items.forEach(item => {
    const card = document.createElement('div');
    card.className = 'sub-card';
    card.innerHTML = `
      <div class="sub-lesson">${item.lessonNum}</div>
      <div class="lesson-info">
        <div class="sub-arrow">
          <span class="sub-old">${item.oldSubject}</span>
          <span class="sub-arrow-icon">‚Üì</span>
          <span class="sub-new">${item.newSubject}</span>
        </div>
        <div class="lesson-meta" style="margin-top:5px">${item.teacher ? '–£—á–∏—Ç–µ–ª—å: '+item.teacher : ''}${item.room ? ' ¬∑ –∫–∞–±. '+item.room : ''}${item.note ? ' ¬∑ '+item.note : ''}</div>
      </div>
      <div class="card-actions">
        <button class="icon-btn" onclick="editSub('${item.id}',${key})">‚úé</button>
        <button class="icon-btn del" onclick="deleteSub('${item.id}',${key})">‚úï</button>
      </div>`;
    list.appendChild(card);
  });
}

function deleteSub(id, day) {
  state.subs[day] = (state.subs[day] || []).filter(s => s.id !== id);
  save(); renderSubs(); renderTodo();
}

function editSub(id, day) {
  const item = state.subs[day].find(s => s.id === id);
  editingId = id;
  openModal('sub', item);
}

// ===== HOMEWORK =====
function renderHW() {
  const list = document.getElementById('hw-list');
  const total = state.hw.length;
  const done = state.hw.filter(h => h.done).length;
  const left = total - done;

  document.getElementById('hw-total').textContent = total;
  document.getElementById('hw-done').textContent = done;
  document.getElementById('hw-left').textContent = left;

  const badge = document.getElementById('hw-badge');
  badge.textContent = left;
  badge.classList.toggle('show', left > 0);

  if (!total) {
    list.innerHTML = `<div class="empty-state"><div class="empty-icon">üéâ</div><div class="empty-text">–î–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π –Ω–µ—Ç!</div></div>`;
    return;
  }

  const sorted = [...state.hw].sort((a, b) => {
    if (a.done !== b.done) return a.done ? 1 : -1;
    return (a.due || '') > (b.due || '') ? 1 : -1;
  });

  list.innerHTML = '';
  sorted.forEach(item => {
    const card = document.createElement('div');
    card.className = 'hw-card' + (item.done ? ' done' : '');

    const now = new Date().toISOString().split('T')[0];
    const overdue = item.due && item.due < now && !item.done;

    card.innerHTML = `
      <div class="hw-top">
        <div class="hw-checkbox" onclick="toggleHW('${item.id}')">${item.done ? '‚úì' : ''}</div>
        <div class="hw-title">${item.title}</div>
        <span class="hw-subject" style="color:${item.color};border-color:${item.color}20;background:${item.color}15">${item.subject}</span>
        <div class="card-actions" style="opacity:1">
          <button class="icon-btn" onclick="editHW('${item.id}')">‚úé</button>
          <button class="icon-btn del" onclick="deleteHW('${item.id}')">‚úï</button>
        </div>
      </div>
      ${item.desc ? `<div class="hw-desc">${item.desc}</div>` : ''}
      ${item.due ? `<div class="hw-due ${overdue ? 'overdue' : ''}">üìÖ –î–æ ${formatDate(item.due)}${overdue ? ' ‚Äî –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ!' : ''}</div>` : ''}`;
    list.appendChild(card);
  });
}

function formatDate(str) {
  const d = new Date(str + 'T12:00:00');
  const months = ['—è–Ω–≤','—Ñ–µ–≤','–º–∞—Ä','–∞–ø—Ä','–º–∞–π','–∏—é–Ω','–∏—é–ª','–∞–≤–≥','—Å–µ–Ω','–æ–∫—Ç','–Ω–æ—è','–¥–µ–∫'];
  return d.getDate() + ' ' + months[d.getMonth()];
}

function toggleHW(id) {
  const item = state.hw.find(h => h.id === id);
  if (item) { item.done = !item.done; save(); renderHW(); }
}

function deleteHW(id) {
  state.hw = state.hw.filter(h => h.id !== id);
  save(); renderHW();
}

function editHW(id) {
  const item = state.hw.find(h => h.id === id);
  editingId = id;
  openModal('hw', item);
}

// ===== TODO =====
function renderTodo() {
  const tomorrowIdx = getTomorrowDayIndex();
  const tomorrowName = DAYS[tomorrowIdx];
  document.getElementById('todo-tomorrow-day').textContent = tomorrowName;

  // Get tomorrow's lessons
  const lessons = (state.lessons[tomorrowIdx] || [])
    .filter(l => !l.isLunch && !l.isSpecial)
    .sort((a, b) => a.num - b.num);

  // Get tomorrow's substitutions
  const subs = state.subs[tomorrowIdx] || [];

  // Build todo items: substituted lessons replace originals
  const subsByNum = {};
  subs.forEach(s => { subsByNum[s.lessonNum] = s; });

  // Build list: take lessons, apply subs
  const todoItems = [];
  const seenNums = new Set();

  lessons.forEach(lesson => {
    const numStr = String(lesson.num);
    const sub = subsByNum[numStr] || subsByNum[lesson.num];

    if (sub) {
      // Add substituted lesson instead
      if (!seenNums.has(numStr + '_sub')) {
        seenNums.add(numStr + '_sub');
        todoItems.push({
          id: 'sub_' + sub.id,
          num: lesson.num,
          name: sub.newSubject,
          room: sub.room || lesson.room,
          color: '#c97fd4',
          isSub: true,
          originalName: sub.oldSubject,
        });
      }
    } else {
      todoItems.push({
        id: 'lesson_' + lesson.id,
        num: lesson.num,
        name: lesson.name,
        room: lesson.room,
        color: lesson.color,
        isSub: false,
      });
    }
  });

  // Also add subs that don't have a matching lesson (e.g., extra lessons)
  subs.forEach(sub => {
    const already = todoItems.find(t => t.isSub && t.num == sub.lessonNum);
    if (!already) {
      todoItems.push({
        id: 'sub_' + sub.id,
        num: sub.lessonNum,
        name: sub.newSubject,
        room: sub.room,
        color: '#c97fd4',
        isSub: true,
        originalName: sub.oldSubject,
      });
    }
  });

  todoItems.sort((a, b) => a.num - b.num);

  const todoKey = 'day_' + tomorrowIdx;
  if (!state.todo[todoKey]) state.todo[todoKey] = {};

  // Cleanup old keys
  todoItems.forEach(item => {
    if (state.todo[todoKey][item.id] === undefined) {
      state.todo[todoKey][item.id] = false;
    }
  });

  const total = todoItems.length;
  const doneCount = todoItems.filter(item => state.todo[todoKey][item.id]).length;
  const pct = total > 0 ? Math.round(doneCount / total * 100) : 0;

  document.getElementById('todo-done-count').textContent = doneCount + '/' + total;
  document.getElementById('todo-progress-fill').style.width = pct + '%';

  const badge = document.getElementById('todo-badge');
  const remaining = total - doneCount;
  badge.textContent = remaining;
  badge.classList.toggle('show', remaining > 0);

  const list = document.getElementById('todo-list');

  if (!todoItems.length) {
    list.innerHTML = `<div class="empty-state"><div class="empty-icon">üéâ</div><div class="empty-text">–ó–∞–≤—Ç—Ä–∞ —É—Ä–æ–∫–æ–≤ –Ω–µ—Ç ‚Äî –æ—Ç–¥—ã—Ö–∞–π!</div></div>`;
    return;
  }

  list.innerHTML = '';
  todoItems.forEach(item => {
    const done = state.todo[todoKey][item.id] || false;
    const time = item.num > 0 && item.num <= 13 ? BELLS[item.num - 1] : '';
    const card = document.createElement('div');
    card.className = 'todo-item' + (done ? ' done' : '');
    card.style.borderLeftColor = item.color;
    card.onclick = () => toggleTodo(todoKey, item.id);
    card.innerHTML = `
      <div class="todo-check">${done ? '‚úì' : ''}</div>
      <div class="todo-item-num" style="color:${item.color};background:${item.color}15">${item.num}</div>
      <div class="todo-item-info">
        <div class="todo-item-name">${item.name}</div>
        <div class="todo-item-meta">${item.room ? '–∫–∞–±. ' + item.room : ''}${item.room && time ? ' ¬∑ ' : ''}${time}</div>
      </div>
      ${item.isSub ? `<span class="todo-sub-badge">–∑–∞–º–µ–Ω–∞</span>` : ''}`;
    list.appendChild(card);
  });

  save();
}

function toggleTodo(todoKey, itemId) {
  if (!state.todo[todoKey]) state.todo[todoKey] = {};
  state.todo[todoKey][itemId] = !state.todo[todoKey][itemId];
  save();
  renderTodo();
}

// ===== MODAL =====
let currentModalType = '';

function openModal(type, data = {}) {
  currentModalType = type;
  if (!data.id) editingId = null;
  selectedColor = data.color || COLORS[type === 'hw' ? 4 : type === 'subs' ? 6 : 0];

  const overlay = document.getElementById('modal-overlay');
  const title = document.getElementById('modal-title');
  const body = document.getElementById('modal-body');
  const actions = document.getElementById('modal-actions');

  if (type === 'lesson') {
    title.textContent = editingId ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —É—Ä–æ–∫' : '–î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–∫';
    body.innerHTML = `
      <div class="form-group">
        <label class="form-label">–ü—Ä–µ–¥–º–µ—Ç</label>
        <input class="form-input" id="f-name" placeholder="–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞" value="${data.name||''}">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">–ù–æ–º–µ—Ä —É—Ä–æ–∫–∞</label>
          <input class="form-input" id="f-num" type="number" min="1" max="13" placeholder="1" value="${data.num||''}">
        </div>
        <div class="form-group">
          <label class="form-label">–ö–∞–±–∏–Ω–µ—Ç</label>
          <input class="form-input" id="f-room" placeholder="212" value="${data.room||''}">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">–£—á–∏—Ç–µ–ª—å</label>
        <input class="form-input" id="f-teacher" placeholder="–ò–≤–∞–Ω–æ–≤ –ò.–ò." value="${data.teacher||''}">
      </div>
      <div class="form-group">
        <label class="form-label">–¶–≤–µ—Ç</label>
        <div class="color-palette" id="color-palette"></div>
      </div>`;
    actions.innerHTML = `
      <button class="btn btn-ghost" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" onclick="saveLesson()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>`;
  } else if (type === 'sub') {
    title.textContent = editingId ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–º–µ–Ω—É' : '–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ–Ω—É';
    body.innerHTML = `
      <div class="form-group">
        <label class="form-label">–ù–æ–º–µ—Ä —É—Ä–æ–∫–∞</label>
        <input class="form-input" id="f-num" type="number" min="1" max="13" placeholder="3" value="${data.lessonNum||''}">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">–ë—ã–ª –ø—Ä–µ–¥–º–µ—Ç</label>
          <input class="form-input" id="f-old" placeholder="–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞" value="${data.oldSubject||''}">
        </div>
        <div class="form-group">
          <label class="form-label">–ó–∞–º–µ–Ω–∏–ª–∏ –Ω–∞</label>
          <input class="form-input" id="f-new" placeholder="–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞" value="${data.newSubject||''}">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">–£—á–∏—Ç–µ–ª—å</label>
          <input class="form-input" id="f-teacher" placeholder="–ü–µ—Ç—Ä–æ–≤ –ü.–ü." value="${data.teacher||''}">
        </div>
        <div class="form-group">
          <label class="form-label">–ö–∞–±–∏–Ω–µ—Ç</label>
          <input class="form-input" id="f-room" placeholder="101" value="${data.room||''}">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">–ó–∞–º–µ—Ç–∫–∞</label>
        <input class="form-input" id="f-note" placeholder="–ü–æ —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–∏—á–∏–Ω–µ" value="${data.note||''}">
      </div>`;
    actions.innerHTML = `
      <button class="btn btn-ghost" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary-purple" onclick="saveSub()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>`;
  } else if (type === 'hw') {
    title.textContent = editingId ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ' : '–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ';
    body.innerHTML = `
      <div class="form-group">
        <label class="form-label">–ó–∞–¥–∞–Ω–∏–µ</label>
        <input class="form-input" id="f-title" placeholder="–ü–∞—Ä–∞–≥—Ä–∞—Ñ 12, —É–ø—Ä. 5‚Äì8" value="${data.title||''}">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">–ü—Ä–µ–¥–º–µ—Ç</label>
          <input class="form-input" id="f-subject" placeholder="–§–∏–∑–∏–∫–∞" value="${data.subject||''}">
        </div>
        <div class="form-group">
          <label class="form-label">–°–¥–∞—Ç—å –¥–æ</label>
          <input class="form-input" id="f-due" type="date" value="${data.due||''}">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
        <textarea class="form-textarea" id="f-desc" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏...">${data.desc||''}</textarea>
      </div>
      <div class="form-group">
        <label class="form-label">–¶–≤–µ—Ç</label>
        <div class="color-palette" id="color-palette"></div>
      </div>`;
    actions.innerHTML = `
      <button class="btn btn-ghost" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary-blue" onclick="saveHW()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>`;
  }

  overlay.classList.add('open');

  const cp = document.getElementById('color-palette');
  if (cp) {
    COLORS.forEach(c => {
      const sw = document.createElement('div');
      sw.className = 'color-swatch' + (c === selectedColor ? ' selected' : '');
      sw.style.background = c;
      sw.onclick = () => {
        selectedColor = c;
        document.querySelectorAll('.color-swatch').forEach(s => s.classList.toggle('selected', s.style.background === c || s.style.backgroundColor === c));
      };
      cp.appendChild(sw);
    });
  }
}

function closeModal() {
  document.getElementById('modal-overlay').classList.remove('open');
  editingId = null;
}

function closeModalOutside(e) {
  if (e.target === document.getElementById('modal-overlay')) closeModal();
}

function saveLesson() {
  const name = document.getElementById('f-name').value.trim();
  const num = parseInt(document.getElementById('f-num').value) || 1;
  if (!name) return;

  const day = currentLessonsDay;
  if (!state.lessons[day]) state.lessons[day] = [];

  const item = {
    id: editingId || uid(),
    name, num,
    time: num > 0 && num <= 13 ? BELLS[num - 1] : '',
    teacher: document.getElementById('f-teacher').value,
    room: document.getElementById('f-room').value,
    color: selectedColor,
  };

  if (editingId) {
    const idx = state.lessons[day].findIndex(l => l.id === editingId);
    if (idx >= 0) state.lessons[day][idx] = item;
  } else {
    state.lessons[day].push(item);
  }

  save(); closeModal(); renderLessons();
}

function saveSub() {
  const lessonNum = document.getElementById('f-num').value;
  const oldSubject = document.getElementById('f-old').value.trim();
  const newSubject = document.getElementById('f-new').value.trim();
  if (!oldSubject || !newSubject) return;

  const day = currentSubsDay;
  if (!state.subs[day]) state.subs[day] = [];

  const item = {
    id: editingId || uid(),
    lessonNum, oldSubject, newSubject,
    teacher: document.getElementById('f-teacher').value,
    room: document.getElementById('f-room').value,
    note: document.getElementById('f-note').value,
  };

  if (editingId) {
    const idx = state.subs[day].findIndex(s => s.id === editingId);
    if (idx >= 0) state.subs[day][idx] = item;
  } else {
    state.subs[day].push(item);
  }

  save(); closeModal(); renderSubs();
}

function saveHW() {
  const title = document.getElementById('f-title').value.trim();
  const subject = document.getElementById('f-subject').value.trim();
  if (!title) return;

  const item = {
    id: editingId || uid(),
    title, subject,
    due: document.getElementById('f-due').value,
    desc: document.getElementById('f-desc').value,
    color: selectedColor,
    done: false,
  };

  if (editingId) {
    const idx = state.hw.findIndex(h => h.id === editingId);
    if (idx >= 0) { item.done = state.hw[idx].done; state.hw[idx] = item; }
  } else {
    state.hw.push(item);
  }

  save(); closeModal(); renderHW();
}

// ===== INIT =====
function init() {
  initDate();
  renderDaySelector('lessons-days', currentLessonsDay, v => { currentLessonsDay = v; }, renderLessons);
  renderDaySelector('subs-days', currentSubsDay, v => { currentSubsDay = v; }, renderSubs);
  renderLessons();
  renderSubs();
  renderHW();
  renderTodo();
}

init();

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
</script>
</body>
</html>
