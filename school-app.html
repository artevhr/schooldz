<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–®–∫–æ–ª—å–Ω—ã–π –î–Ω–µ–≤–Ω–∏–∫</title>
<link href="https://fonts.googleapis.com/css2?family=Geologica:wght@300;400;500;600;700&family=Unbounded:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f0f14;
    --surface: #16161e;
    --surface2: #1e1e2a;
    --surface3: #252535;
    --border: rgba(255,255,255,0.07);
    --accent: #e8a45a;
    --accent2: #c97fd4;
    --accent3: #5acfe8;
    --text: #e8e8f0;
    --text2: #9090aa;
    --text3: #5a5a72;
    --danger: #e85a5a;
    --success: #5ae8a4;
    --r: 14px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Geologica', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Background mesh */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 60% 40% at 20% 20%, rgba(232,164,90,0.08) 0%, transparent 70%),
      radial-gradient(ellipse 50% 50% at 80% 80%, rgba(201,127,212,0.06) 0%, transparent 70%),
      radial-gradient(ellipse 40% 60% at 60% 40%, rgba(90,207,232,0.04) 0%, transparent 70%);
    pointer-events: none;
    z-index: 0;
  }

  .app {
    position: relative;
    z-index: 1;
    max-width: 960px;
    margin: 0 auto;
    padding: 32px 20px 60px;
  }

  /* Header */
  header {
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    margin-bottom: 40px;
    padding-bottom: 28px;
    border-bottom: 1px solid var(--border);
  }

  .logo {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .logo-tag {
    font-size: 10px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--accent);
    font-weight: 500;
  }

  .logo-title {
    font-family: 'Unbounded', sans-serif;
    font-size: 28px;
    font-weight: 700;
    line-height: 1;
    background: linear-gradient(135deg, var(--text) 0%, var(--accent) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .date-badge {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 18px;
    text-align: right;
  }

  .date-badge .day {
    font-size: 22px;
    font-weight: 600;
    color: var(--text);
    line-height: 1;
  }

  .date-badge .weekday {
    font-size: 11px;
    color: var(--text2);
    text-transform: uppercase;
    letter-spacing: 0.12em;
    margin-top: 3px;
  }

  /* Tabs */
  .tabs {
    display: flex;
    gap: 4px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--r);
    padding: 5px;
    margin-bottom: 28px;
  }

  .tab-btn {
    flex: 1;
    padding: 12px 20px;
    border: none;
    border-radius: calc(var(--r) - 3px);
    background: transparent;
    color: var(--text2);
    font-family: 'Geologica', sans-serif;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.25s ease;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .tab-btn:hover:not(.active) {
    color: var(--text);
    background: var(--surface2);
  }

  .tab-btn.active {
    background: var(--surface3);
    color: var(--text);
  }

  .tab-btn.active::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 50%;
    transform: translateX(-50%);
    width: 30px;
    height: 2px;
    border-radius: 2px;
  }

  .tab-btn[data-tab="lessons"].active::after { background: var(--accent); }
  .tab-btn[data-tab="subs"].active::after { background: var(--accent2); }
  .tab-btn[data-tab="hw"].active::after { background: var(--accent3); }

  .tab-btn[data-tab="lessons"].active .tab-icon { color: var(--accent); }
  .tab-btn[data-tab="subs"].active .tab-icon { color: var(--accent2); }
  .tab-btn[data-tab="hw"].active .tab-icon { color: var(--accent3); }

  .tab-icon { font-size: 16px; }

  .badge {
    background: var(--accent2);
    color: white;
    font-size: 10px;
    font-weight: 700;
    padding: 1px 6px;
    border-radius: 20px;
    line-height: 1.6;
    opacity: 0;
    transform: scale(0.8);
    transition: all 0.2s;
  }

  .badge.show {
    opacity: 1;
    transform: scale(1);
  }

  /* Panels */
  .panel {
    display: none;
    animation: fadeIn 0.3s ease;
  }

  .panel.active { display: block; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Section header */
  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .section-title {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.18em;
    color: var(--text3);
  }

  .add-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text2);
    font-family: 'Geologica', sans-serif;
    font-size: 13px;
    font-weight: 500;
    padding: 8px 14px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .add-btn:hover {
    background: var(--surface3);
    color: var(--text);
    border-color: rgba(255,255,255,0.12);
  }

  /* Day selector */
  .day-selector {
    display: flex;
    gap: 6px;
    margin-bottom: 20px;
    overflow-x: auto;
    padding-bottom: 4px;
  }

  .day-selector::-webkit-scrollbar { height: 3px; }
  .day-selector::-webkit-scrollbar-track { background: transparent; }
  .day-selector::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 3px; }

  .day-pill {
    flex-shrink: 0;
    padding: 8px 16px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text2);
    font-family: 'Geologica', sans-serif;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .day-pill:hover { color: var(--text); border-color: rgba(255,255,255,0.12); }

  .day-pill.active {
    background: var(--surface3);
    color: var(--text);
    border-color: rgba(255,255,255,0.15);
  }

  /* Lesson card */
  .lessons-list, .hw-list, .subs-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .lesson-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--r);
    padding: 16px 18px;
    display: flex;
    align-items: center;
    gap: 14px;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }

  .lesson-card::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 3px;
    border-radius: 3px 0 0 3px;
  }

  .lesson-card:hover {
    background: var(--surface2);
    border-color: rgba(255,255,255,0.1);
    transform: translateX(2px);
  }

  .lesson-num {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    background: var(--surface2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    font-weight: 600;
    color: var(--text2);
    flex-shrink: 0;
  }

  .lesson-info { flex: 1; min-width: 0; }

  .lesson-name {
    font-size: 15px;
    font-weight: 500;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .lesson-meta {
    font-size: 12px;
    color: var(--text3);
    margin-top: 3px;
  }

  .card-actions {
    display: flex;
    gap: 6px;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .lesson-card:hover .card-actions { opacity: 1; }

  .icon-btn {
    width: 30px;
    height: 30px;
    border-radius: 7px;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--text2);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    transition: all 0.2s;
  }

  .icon-btn:hover { background: var(--surface3); color: var(--text); }
  .icon-btn.del:hover { background: rgba(232,90,90,0.15); color: var(--danger); border-color: rgba(232,90,90,0.3); }

  /* Color dots */
  .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  /* Homework card */
  .hw-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--r);
    padding: 16px 18px;
    transition: all 0.2s;
    position: relative;
  }

  .hw-card:hover {
    background: var(--surface2);
    border-color: rgba(255,255,255,0.1);
  }

  .hw-card.done { opacity: 0.5; }
  .hw-card.done .hw-title { text-decoration: line-through; color: var(--text3); }

  .hw-top {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
  }

  .hw-checkbox {
    width: 20px;
    height: 20px;
    border-radius: 6px;
    border: 2px solid var(--border);
    background: transparent;
    cursor: pointer;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    color: var(--success);
    transition: all 0.2s;
  }

  .hw-card.done .hw-checkbox {
    background: rgba(90,232,164,0.15);
    border-color: var(--success);
  }

  .hw-title {
    font-size: 15px;
    font-weight: 500;
    flex: 1;
  }

  .hw-subject {
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 3px 8px;
    border-radius: 6px;
    border: 1px solid;
  }

  .hw-desc {
    font-size: 13px;
    color: var(--text2);
    line-height: 1.5;
    padding-left: 32px;
  }

  .hw-due {
    font-size: 12px;
    color: var(--text3);
    margin-top: 8px;
    padding-left: 32px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .hw-due.overdue { color: var(--danger); }

  /* Subs card */
  .sub-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--r);
    padding: 16px 18px;
    display: flex;
    align-items: center;
    gap: 14px;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }

  .sub-card:hover {
    background: var(--surface2);
    border-color: rgba(255,255,255,0.1);
  }

  .sub-arrow {
    display: flex;
    flex-direction: column;
    gap: 2px;
    align-items: center;
  }

  .sub-old {
    font-size: 12px;
    color: var(--danger);
    text-decoration: line-through;
  }

  .sub-arrow-icon { color: var(--text3); font-size: 14px; }

  .sub-new {
    font-size: 13px;
    color: var(--success);
    font-weight: 500;
  }

  .sub-lesson {
    width: 36px;
    height: 36px;
    border-radius: 9px;
    background: rgba(201,127,212,0.12);
    border: 1px solid rgba(201,127,212,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    font-weight: 700;
    color: var(--accent2);
    flex-shrink: 0;
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(8px);
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s;
  }

  .modal-overlay.open {
    opacity: 1;
    pointer-events: all;
  }

  .modal {
    background: var(--surface);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 20px;
    padding: 28px;
    width: 100%;
    max-width: 420px;
    transform: translateY(20px) scale(0.97);
    transition: transform 0.25s ease;
    box-shadow: 0 40px 80px rgba(0,0,0,0.5);
  }

  .modal-overlay.open .modal {
    transform: translateY(0) scale(1);
  }

  .modal-title {
    font-family: 'Unbounded', sans-serif;
    font-size: 18px;
    margin-bottom: 24px;
    color: var(--text);
  }

  .form-group {
    margin-bottom: 16px;
  }

  .form-label {
    display: block;
    font-size: 12px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--text3);
    margin-bottom: 8px;
  }

  .form-input, .form-select, .form-textarea {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-family: 'Geologica', sans-serif;
    font-size: 14px;
    padding: 11px 14px;
    outline: none;
    transition: border-color 0.2s;
  }

  .form-textarea {
    resize: vertical;
    min-height: 80px;
  }

  .form-input:focus, .form-select:focus, .form-textarea:focus {
    border-color: var(--accent);
  }

  .form-select option { background: var(--surface); }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .modal-actions {
    display: flex;
    gap: 10px;
    margin-top: 24px;
  }

  .btn {
    flex: 1;
    padding: 12px;
    border-radius: 10px;
    border: none;
    font-family: 'Geologica', sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-ghost {
    background: var(--surface2);
    color: var(--text2);
  }

  .btn-ghost:hover {
    background: var(--surface3);
    color: var(--text);
  }

  .btn-primary {
    background: var(--accent);
    color: #1a0a00;
  }

  .btn-primary:hover {
    background: #f0b870;
  }

  .btn-primary-blue {
    background: var(--accent3);
    color: #001a20;
  }

  .btn-primary-purple {
    background: var(--accent2);
    color: #1a001f;
  }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text3);
  }

  .empty-icon { font-size: 40px; margin-bottom: 12px; opacity: 0.5; }
  .empty-text { font-size: 14px; }

  /* Colors palette */
  .color-palette {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .color-swatch {
    width: 28px;
    height: 28px;
    border-radius: 7px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.15s;
  }

  .color-swatch.selected {
    border-color: white;
    transform: scale(1.15);
  }

  /* Stats bar */
  .stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 28px;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--r);
    padding: 14px 16px;
    text-align: center;
  }

  .stat-num {
    font-family: 'Unbounded', sans-serif;
    font-size: 24px;
    font-weight: 700;
    line-height: 1;
  }

  .stat-label {
    font-size: 11px;
    color: var(--text3);
    margin-top: 5px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 5px; }
</style>
</head>
<body>

<div class="app">
  <header>
    <div class="logo">
      <span class="logo-tag">–º–æ–π –¥–Ω–µ–≤–Ω–∏–∫</span>
      <span class="logo-title">SchoolBook</span>
    </div>
    <div class="date-badge">
      <div class="day" id="current-date"></div>
      <div class="weekday" id="current-weekday"></div>
    </div>
  </header>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="lessons" onclick="switchTab('lessons')">
      <span class="tab-icon">üìö</span> –£—Ä–æ–∫–∏
    </button>
    <button class="tab-btn" data-tab="subs" onclick="switchTab('subs')">
      <span class="tab-icon">üîÑ</span> –ó–∞–º–µ–Ω—ã
      <span class="badge" id="subs-badge"></span>
    </button>
    <button class="tab-btn" data-tab="hw" onclick="switchTab('hw')">
      <span class="tab-icon">‚úèÔ∏è</span> –î–æ–º–∞—à–∫–∞
      <span class="badge" id="hw-badge"></span>
    </button>
  </div>

  <!-- –£–†–û–ö–ò -->
  <div class="panel active" id="panel-lessons">
    <div class="day-selector" id="lessons-days"></div>
    <div class="section-header">
      <span class="section-title" id="lessons-day-title">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</span>
      <button class="add-btn" onclick="openModal('lesson')">Ôºã –î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–∫</button>
    </div>
    <div class="lessons-list" id="lessons-list"></div>
  </div>

  <!-- –ó–ê–ú–ï–ù–´ -->
  <div class="panel" id="panel-subs">
    <div class="day-selector" id="subs-days"></div>
    <div class="section-header">
      <span class="section-title">–ó–∞–º–µ–Ω—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</span>
      <button class="add-btn" onclick="openModal('sub')">Ôºã –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ–Ω—É</button>
    </div>
    <div class="subs-list" id="subs-list"></div>
  </div>

  <!-- –î–û–ú–ê–®–ö–ê -->
  <div class="panel" id="panel-hw">
    <div class="stats">
      <div class="stat-card">
        <div class="stat-num" id="hw-total" style="color:var(--accent3)">0</div>
        <div class="stat-label">–í—Å–µ–≥–æ</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" id="hw-done" style="color:var(--success)">0</div>
        <div class="stat-label">–°–¥–∞–Ω–æ</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" id="hw-left" style="color:var(--accent)">0</div>
        <div class="stat-label">–û—Å—Ç–∞–ª–æ—Å—å</div>
      </div>
    </div>
    <div class="section-header">
      <span class="section-title">–ó–∞–¥–∞–Ω–∏—è</span>
      <button class="add-btn" onclick="openModal('hw')">Ôºã –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
    </div>
    <div class="hw-list" id="hw-list"></div>
  </div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modal-overlay" onclick="closeModalOutside(event)">
  <div class="modal" id="modal">
    <div class="modal-title" id="modal-title">–î–æ–±–∞–≤–∏—Ç—å</div>
    <div id="modal-body"></div>
    <div class="modal-actions" id="modal-actions"></div>
  </div>
</div>

<script>
// ===== DATA =====
const DAYS = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–í—Ç–æ—Ä–Ω–∏–∫','–°—Ä–µ–¥–∞','–ß–µ—Ç–≤–µ—Ä–≥','–ü—è—Ç–Ω–∏—Ü–∞','–°—É–±–±–æ—Ç–∞'];
const SHORT_DAYS = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'];
const COLORS = ['#e85a5a','#e8a45a','#e8e85a','#5ae870','#5acfe8','#5a70e8','#c97fd4','#e8709a'];
const SUBJECTS = ['–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞','–†—É—Å—Å–∫–∏–π','–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞','–§–∏–∑–∏–∫–∞','–•–∏–º–∏—è','–ë–∏–æ–ª–æ–≥–∏—è','–ò—Å—Ç–æ—Ä–∏—è','Geography','–ê–Ω–≥–ª–∏–π—Å–∫–∏–π','–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞','–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞','–ú—É–∑—ã–∫–∞','–ò–ó–û'];

let state = {
  lessons: JSON.parse(localStorage.getItem('sb_lessons') || '{}'),
  subs: JSON.parse(localStorage.getItem('sb_subs') || '{}'),
  hw: JSON.parse(localStorage.getItem('sb_hw') || '[]'),
};

let currentLessonsDay = 0;
let currentSubsDay = 0;
let editingId = null;
let selectedColor = COLORS[0];

function save() {
  localStorage.setItem('sb_lessons', JSON.stringify(state.lessons));
  localStorage.setItem('sb_subs', JSON.stringify(state.subs));
  localStorage.setItem('sb_hw', JSON.stringify(state.hw));
}

function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2); }

// ===== DATE =====
function initDate() {
  const now = new Date();
  const months = ['—è–Ω–≤','—Ñ–µ–≤','–º–∞—Ä','–∞–ø—Ä','–º–∞–π','–∏—é–Ω','–∏—é–ª','–∞–≤–≥','—Å–µ–Ω','–æ–∫—Ç','–Ω–æ—è','–¥–µ–∫'];
  const wdays = ['–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ','–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–í—Ç–æ—Ä–Ω–∏–∫','–°—Ä–µ–¥–∞','–ß–µ—Ç–≤–µ—Ä–≥','–ü—è—Ç–Ω–∏—Ü–∞','–°—É–±–±–æ—Ç–∞'];
  document.getElementById('current-date').textContent = now.getDate() + ' ' + months[now.getMonth()];
  document.getElementById('current-weekday').textContent = wdays[now.getDay()];
  // Set current day
  const d = now.getDay();
  currentLessonsDay = (d === 0 || d === 7) ? 0 : d - 1;
  currentSubsDay = currentLessonsDay;
}

// ===== TABS =====
function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
  document.querySelectorAll('.panel').forEach(p => p.classList.toggle('active', p.id === 'panel-' + tab));
}

// ===== DAY SELECTORS =====
function renderDaySelector(containerId, current, setCurrent, onSelect) {
  const el = document.getElementById(containerId);
  el.innerHTML = '';
  DAYS.forEach((day, i) => {
    const btn = document.createElement('button');
    btn.className = 'day-pill' + (i === current ? ' active' : '');
    btn.textContent = SHORT_DAYS[i];
    btn.onclick = () => { setCurrent(i); onSelect(); renderDaySelector(containerId, i, setCurrent, onSelect); };
    el.appendChild(btn);
  });
}

// ===== LESSONS =====
function renderLessons() {
  const key = currentLessonsDay;
  const items = (state.lessons[key] || []).sort((a,b) => a.num - b.num);
  const list = document.getElementById('lessons-list');
  document.getElementById('lessons-day-title').textContent = DAYS[key];

  if (!items.length) {
    list.innerHTML = `<div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-text">–ù–µ—Ç —É—Ä–æ–∫–æ–≤ ‚Äî –¥–æ–±–∞–≤—å—Ç–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div></div>`;
    return;
  }

  list.innerHTML = '';
  items.forEach(item => {
    const card = document.createElement('div');
    card.className = 'lesson-card';
    card.style.borderLeftColor = item.color;
    card.innerHTML = `
      <style>.lesson-card[data-id="${item.id}"]::before { background: ${item.color}; }</style>
      <div class="lesson-num" style="color:${item.color}">${item.num}</div>
      <div class="lesson-info">
        <div class="lesson-name">${item.name}</div>
        <div class="lesson-meta">${item.teacher ? item.teacher + ' ¬∑ ' : ''}${item.room ? '–∫–∞–±. '+item.room : ''}${item.time ? ' ¬∑ '+item.time : ''}</div>
      </div>
      <div class="card-actions">
        <button class="icon-btn" onclick="editLesson('${item.id}',${key})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úé</button>
        <button class="icon-btn del" onclick="deleteLesson('${item.id}',${key})" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
      </div>`;
    card.dataset.id = item.id;
    list.appendChild(card);
  });
}

function deleteLesson(id, day) {
  state.lessons[day] = (state.lessons[day] || []).filter(l => l.id !== id);
  save(); renderLessons();
}

function editLesson(id, day) {
  const item = state.lessons[day].find(l => l.id === id);
  editingId = id;
  openModal('lesson', item);
}

// ===== SUBS =====
function renderSubs() {
  const key = currentSubsDay;
  const items = state.subs[key] || [];
  const list = document.getElementById('subs-list');
  const badge = document.getElementById('subs-badge');

  const total = Object.values(state.subs).flat().length;
  badge.textContent = total;
  badge.classList.toggle('show', total > 0);

  if (!items.length) {
    list.innerHTML = `<div class="empty-state"><div class="empty-icon">‚úÖ</div><div class="empty-text">–ó–∞–º–µ–Ω –Ω–µ—Ç ‚Äî –≤—Å—ë –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é</div></div>`;
    return;
  }

  list.innerHTML = '';
  items.forEach(item => {
    const card = document.createElement('div');
    card.className = 'sub-card';
    card.innerHTML = `
      <div class="sub-lesson">${item.lessonNum}</div>
      <div class="lesson-info">
        <div class="sub-arrow">
          <span class="sub-old">${item.oldSubject}</span>
          <span class="sub-arrow-icon">‚Üì</span>
          <span class="sub-new">${item.newSubject}</span>
        </div>
        <div class="lesson-meta" style="margin-top:6px">${item.teacher ? '–£—á–∏—Ç–µ–ª—å: '+item.teacher : ''}${item.room ? ' ¬∑ –∫–∞–±. '+item.room : ''}${item.note ? ' ¬∑ '+item.note : ''}</div>
      </div>
      <div class="card-actions">
        <button class="icon-btn" onclick="editSub('${item.id}',${key})">‚úé</button>
        <button class="icon-btn del" onclick="deleteSub('${item.id}',${key})">‚úï</button>
      </div>`;
    list.appendChild(card);
  });
}

function deleteSub(id, day) {
  state.subs[day] = (state.subs[day] || []).filter(s => s.id !== id);
  save(); renderSubs();
}

function editSub(id, day) {
  const item = state.subs[day].find(s => s.id === id);
  editingId = id;
  openModal('sub', item);
}

// ===== HOMEWORK =====
function renderHW() {
  const list = document.getElementById('hw-list');
  const total = state.hw.length;
  const done = state.hw.filter(h => h.done).length;
  const left = total - done;

  document.getElementById('hw-total').textContent = total;
  document.getElementById('hw-done').textContent = done;
  document.getElementById('hw-left').textContent = left;

  const badge = document.getElementById('hw-badge');
  badge.textContent = left;
  badge.classList.toggle('show', left > 0);

  if (!total) {
    list.innerHTML = `<div class="empty-state"><div class="empty-icon">üéâ</div><div class="empty-text">–î–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π –Ω–µ—Ç ‚Äî –æ—Ç–¥—ã—Ö–∞–π!</div></div>`;
    return;
  }

  const sorted = [...state.hw].sort((a,b) => {
    if (a.done !== b.done) return a.done ? 1 : -1;
    return (a.due || '') > (b.due || '') ? 1 : -1;
  });

  list.innerHTML = '';
  sorted.forEach(item => {
    const card = document.createElement('div');
    card.className = 'hw-card' + (item.done ? ' done' : '');

    const now = new Date().toISOString().split('T')[0];
    const overdue = item.due && item.due < now && !item.done;

    card.innerHTML = `
      <div class="hw-top">
        <div class="hw-checkbox" onclick="toggleHW('${item.id}')">${item.done ? '‚úì' : ''}</div>
        <div class="hw-title">${item.title}</div>
        <span class="hw-subject" style="color:${item.color};border-color:${item.color}20;background:${item.color}15">${item.subject}</span>
        <div class="card-actions" style="opacity:1">
          <button class="icon-btn" onclick="editHW('${item.id}')">‚úé</button>
          <button class="icon-btn del" onclick="deleteHW('${item.id}')">‚úï</button>
        </div>
      </div>
      ${item.desc ? `<div class="hw-desc">${item.desc}</div>` : ''}
      ${item.due ? `<div class="hw-due ${overdue ? 'overdue' : ''}">üìÖ –î–æ ${formatDate(item.due)}${overdue ? ' ‚Äî –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ!' : ''}</div>` : ''}`;
    list.appendChild(card);
  });
}

function formatDate(str) {
  const d = new Date(str + 'T12:00:00');
  const months = ['—è–Ω–≤','—Ñ–µ–≤','–º–∞—Ä','–∞–ø—Ä','–º–∞–π','–∏—é–Ω','–∏—é–ª','–∞–≤–≥','—Å–µ–Ω','–æ–∫—Ç','–Ω–æ—è','–¥–µ–∫'];
  return d.getDate() + ' ' + months[d.getMonth()];
}

function toggleHW(id) {
  const item = state.hw.find(h => h.id === id);
  if (item) { item.done = !item.done; save(); renderHW(); }
}

function deleteHW(id) {
  state.hw = state.hw.filter(h => h.id !== id);
  save(); renderHW();
}

function editHW(id) {
  const item = state.hw.find(h => h.id === id);
  editingId = id;
  openModal('hw', item);
}

// ===== MODAL =====
let currentModalType = '';

function openModal(type, data = {}) {
  currentModalType = type;
  if (!data.id) editingId = null;
  selectedColor = data.color || COLORS[type === 'hw' ? 4 : type === 'subs' ? 6 : 0];

  const overlay = document.getElementById('modal-overlay');
  const title = document.getElementById('modal-title');
  const body = document.getElementById('modal-body');
  const actions = document.getElementById('modal-actions');

  if (type === 'lesson') {
    title.textContent = editingId ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —É—Ä–æ–∫' : '–î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–∫';
    body.innerHTML = `
      <div class="form-group">
        <label class="form-label">–ü—Ä–µ–¥–º–µ—Ç</label>
        <input class="form-input" id="f-name" placeholder="–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞" value="${data.name||''}">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">–ù–æ–º–µ—Ä —É—Ä–æ–∫–∞</label>
          <input class="form-input" id="f-num" type="number" min="1" max="12" placeholder="1" value="${data.num||''}">
        </div>
        <div class="form-group">
          <label class="form-label">–í—Ä–µ–º—è</label>
          <input class="form-input" id="f-time" placeholder="8:30‚Äì9:15" value="${data.time||''}">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">–£—á–∏—Ç–µ–ª—å</label>
          <input class="form-input" id="f-teacher" placeholder="–ò–≤–∞–Ω–æ–≤ –ò.–ò." value="${data.teacher||''}">
        </div>
        <div class="form-group">
          <label class="form-label">–ö–∞–±–∏–Ω–µ—Ç</label>
          <input class="form-input" id="f-room" placeholder="212" value="${data.room||''}">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">–¶–≤–µ—Ç</label>
        <div class="color-palette" id="color-palette"></div>
      </div>`;
    actions.innerHTML = `
      <button class="btn btn-ghost" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" onclick="saveLesson()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>`;
  }

  else if (type === 'sub') {
    title.textContent = editingId ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–º–µ–Ω—É' : '–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ–Ω—É';
    body.innerHTML = `
      <div class="form-group">
        <label class="form-label">–ù–æ–º–µ—Ä —É—Ä–æ–∫–∞</label>
        <input class="form-input" id="f-num" type="number" min="1" max="12" placeholder="3" value="${data.lessonNum||''}">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">–ë—ã–ª –ø—Ä–µ–¥–º–µ—Ç</label>
          <input class="form-input" id="f-old" placeholder="–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞" value="${data.oldSubject||''}">
        </div>
        <div class="form-group">
          <label class="form-label">–ó–∞–º–µ–Ω–∏–ª–∏ –Ω–∞</label>
          <input class="form-input" id="f-new" placeholder="–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞" value="${data.newSubject||''}">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">–£—á–∏—Ç–µ–ª—å</label>
          <input class="form-input" id="f-teacher" placeholder="–ü–µ—Ç—Ä–æ–≤ –ü.–ü." value="${data.teacher||''}">
        </div>
        <div class="form-group">
          <label class="form-label">–ö–∞–±–∏–Ω–µ—Ç</label>
          <input class="form-input" id="f-room" placeholder="101" value="${data.room||''}">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">–ó–∞–º–µ—Ç–∫–∞</label>
        <input class="form-input" id="f-note" placeholder="–ü–æ —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–∏—á–∏–Ω–µ" value="${data.note||''}">
      </div>`;
    actions.innerHTML = `
      <button class="btn btn-ghost" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary-purple" onclick="saveSub()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>`;
  }

  else if (type === 'hw') {
    title.textContent = editingId ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ' : '–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ';
    body.innerHTML = `
      <div class="form-group">
        <label class="form-label">–ó–∞–¥–∞–Ω–∏–µ</label>
        <input class="form-input" id="f-title" placeholder="–ü–∞—Ä–∞–≥—Ä–∞—Ñ 12, —É–ø—Ä. 5‚Äì8" value="${data.title||''}">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">–ü—Ä–µ–¥–º–µ—Ç</label>
          <input class="form-input" id="f-subject" placeholder="–§–∏–∑–∏–∫–∞" value="${data.subject||''}">
        </div>
        <div class="form-group">
          <label class="form-label">–°–¥–∞—Ç—å –¥–æ</label>
          <input class="form-input" id="f-due" type="date" value="${data.due||''}">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
        <textarea class="form-textarea" id="f-desc" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏...">${data.desc||''}</textarea>
      </div>
      <div class="form-group">
        <label class="form-label">–¶–≤–µ—Ç</label>
        <div class="color-palette" id="color-palette"></div>
      </div>`;
    actions.innerHTML = `
      <button class="btn btn-ghost" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary-blue" onclick="saveHW()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>`;
  }

  overlay.classList.add('open');

  // Render color palette
  const cp = document.getElementById('color-palette');
  if (cp) {
    COLORS.forEach(c => {
      const sw = document.createElement('div');
      sw.className = 'color-swatch' + (c === selectedColor ? ' selected' : '');
      sw.style.background = c;
      sw.onclick = () => {
        selectedColor = c;
        document.querySelectorAll('.color-swatch').forEach(s => s.classList.toggle('selected', s.style.background === c || s.style.backgroundColor === c));
      };
      cp.appendChild(sw);
    });
  }
}

function closeModal() {
  document.getElementById('modal-overlay').classList.remove('open');
  editingId = null;
}

function closeModalOutside(e) {
  if (e.target === document.getElementById('modal-overlay')) closeModal();
}

function saveLesson() {
  const name = document.getElementById('f-name').value.trim();
  const num = parseInt(document.getElementById('f-num').value) || 1;
  if (!name) return;

  const day = currentLessonsDay;
  if (!state.lessons[day]) state.lessons[day] = [];

  const item = {
    id: editingId || uid(),
    name, num,
    time: document.getElementById('f-time').value,
    teacher: document.getElementById('f-teacher').value,
    room: document.getElementById('f-room').value,
    color: selectedColor
  };

  if (editingId) {
    const idx = state.lessons[day].findIndex(l => l.id === editingId);
    if (idx >= 0) state.lessons[day][idx] = item;
  } else {
    state.lessons[day].push(item);
  }

  save(); closeModal(); renderLessons();
}

function saveSub() {
  const lessonNum = document.getElementById('f-num').value;
  const oldSubject = document.getElementById('f-old').value.trim();
  const newSubject = document.getElementById('f-new').value.trim();
  if (!oldSubject || !newSubject) return;

  const day = currentSubsDay;
  if (!state.subs[day]) state.subs[day] = [];

  const item = {
    id: editingId || uid(),
    lessonNum, oldSubject, newSubject,
    teacher: document.getElementById('f-teacher').value,
    room: document.getElementById('f-room').value,
    note: document.getElementById('f-note').value,
  };

  if (editingId) {
    const idx = state.subs[day].findIndex(s => s.id === editingId);
    if (idx >= 0) state.subs[day][idx] = item;
  } else {
    state.subs[day].push(item);
  }

  save(); closeModal(); renderSubs();
}

function saveHW() {
  const title = document.getElementById('f-title').value.trim();
  const subject = document.getElementById('f-subject').value.trim();
  if (!title) return;

  const item = {
    id: editingId || uid(),
    title, subject,
    due: document.getElementById('f-due').value,
    desc: document.getElementById('f-desc').value,
    color: selectedColor,
    done: false
  };

  if (editingId) {
    const idx = state.hw.findIndex(h => h.id === editingId);
    if (idx >= 0) { item.done = state.hw[idx].done; state.hw[idx] = item; }
  } else {
    state.hw.push(item);
  }

  save(); closeModal(); renderHW();
}

// ===== INIT =====
function init() {
  initDate();
  renderDaySelector('lessons-days', currentLessonsDay, v => { currentLessonsDay = v; }, renderLessons);
  renderDaySelector('subs-days', currentSubsDay, v => { currentSubsDay = v; }, renderSubs);
  renderLessons();
  renderSubs();
  renderHW();
}

init();

// keyboard
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
</script>
</body>
</html>
